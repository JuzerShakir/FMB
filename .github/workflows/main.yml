# This workflow uses actions that are not certified by GitHub.  They are
# provided by a third-party and are governed by separate terms of service,
# privacy policy, and support documentation.
#
# This workflow will install a prebuilt Ruby version, install dependencies, and
# run tests and linters.
name: Testing the application

on:
    push:
        branches: ["pre-production"]
    pull_request:
        branches: ["pre-production"]

jobs:
    rspec-test:
        runs-on:
            ubuntu-latest
            # Service containers to run with `container-job`
        services:
            # Label used to access the service container
            postgres:
                # Docker Hub image
                image: postgres
                # Provide the password for postgres
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: password
                ports: ["5432:5432"]
                # Set health checks to wait until postgres has started
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
        steps:
            - name: Check out repository code
              uses: actions/checkout@v3

            - name: Setting up Ruby
              uses: ruby/setup-ruby@v1.138.0
              with:
                  ruby-version: 3.1.2

            - name: Installing Bundler & Gems
              run: |
                  gem install bundler
                  bundle install

            - name: Preparing Database
              env:
                  DATABASE_URL: postgres://postgres:password@localhost:5432/test
                  RAILS_ENV: test
                  PG_USER: postgres
              run: |
                  bundle exec rails db:create
                  bundle exec rails db:migrate

            - name: Testing routes
              env:
                  DATABASE_URL: postgres://postgres:password@localhost:5432/test
                  RAILS_ENV: test
                  PG_USER: postgres
              run: rspec spec/routing -fd

            - name: Testing requests
              env:
                  DATABASE_URL: postgres://postgres:password@localhost:5432/test
                  RAILS_ENV: test
                  PG_USER: postgres
              run: |
                  bundle exec rails assets:precompile
                  rspec spec/requests -fd

            - name: Testing models
              env:
                  DATABASE_URL: postgres://postgres:password@localhost:5432/test
                  RAILS_ENV: test
                  PG_USER: postgres
              run: rspec spec/models -fd

            - name: Testing helpers
              env:
                  DATABASE_URL: postgres://postgres:password@localhost:5432/test
                  RAILS_ENV: test
                  PG_USER: postgres
              run: rspec spec/helpers -fd
